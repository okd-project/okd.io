<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The Community Distribution of Kubernetes that powers Red Hat OpenShift"><meta name=author content="Brian Innes"><link href=https://openshift-cs.github.io/okd.io/index.html/blog/2022-12-12-Building-OKD-payload/ rel=canonical><link rel=icon href=../../img/okdLogo.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.1.6"><title>Building the OKD payload - OKD.io</title><link rel=stylesheet href=../../assets/stylesheets/main.ded33207.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.a0c5b2b5.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Open Sans";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=okd data-md-color-primary=blue-grey data-md-color-accent=red> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#building-the-okd-payload class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=OKD.io class="md-header__button md-logo" aria-label=OKD.io data-md-component=logo> <img src=../../img/okd_logo_resized.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> OKD.io </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Building the OKD payload </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=okd data-md-color-primary=blue-grey data-md-color-accent=red aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=okd-dark data-md-color-primary=okd-blue data-md-color-accent=okd-light-green aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/okd-project/okd.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> okd-io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=OKD.io class="md-nav__button md-logo" aria-label=OKD.io data-md-component=logo> <img src=../../img/okd_logo_resized.svg alt=logo> </a> OKD.io </label> <div class=md-nav__source> <a href=https://github.com/okd-project/okd.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> okd-io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../about/ class=md-nav__link> About </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> Getting Started <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../installation/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../crc/ class=md-nav__link> CRC </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> Guides <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../guides/automated-vsphere-upi/ class=md-nav__link> Automated vSphere install </a> </li> <li class=md-nav__item> <a href=../../guides/vsphere-prereqs/ class=md-nav__link> Prerequites for vSphere UPI </a> </li> <li class=md-nav__item> <a href=../../guides/vsphere-ipi/ class=md-nav__link> vSphere IPI Deployment </a> </li> <li class=md-nav__item> <a href=../../guides/sno/ class=md-nav__link> Single Node OKD Installation </a> </li> <li class=md-nav__item> <a href=../../guides/vadim/ class=md-nav__link> Vadim's homelab </a> </li> <li class=md-nav__item> <a href=../../guides/sri/ class=md-nav__link> Sri's homelab </a> </li> <li class=md-nav__item> <a href=../../guides/azure-ipi/ class=md-nav__link> Azure IPI Default Deployment </a> </li> <li class=md-nav__item> <a href=../../guides/aws-ipi/ class=md-nav__link> AWS IPI Default Deployment </a> </li> <li class=md-nav__item> <a href=../../guides/gcp-ipi/ class=md-nav__link> GCP IPI Default Deployment </a> </li> <li class=md-nav__item> <a href=../../guides/virt-baremetal-upi/ class=md-nav__link> OKD Virtualization </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../docs/ class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=../ class=md-nav__link> Blog </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> Community <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Community </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../community/ class=md-nav__link> OKD Community </a> </li> <li class=md-nav__item> <a href=../../conduct/ class=md-nav__link> Code of Conduct </a> </li> <li class=md-nav__item> <a href=../../contributor/ class=md-nav__link> Contributor </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> OKD Working Group <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> OKD Working Group </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../working-groups/ class=md-nav__link> About </a> </li> <li class=md-nav__item> <a href=../../charter/ class=md-nav__link> Charter </a> </li> <li class=md-nav__item> <a href=../../communications/ class=md-nav__link> Communications </a> </li> <li class=md-nav__item> <a href=../../working-group/minutes/minutes/ class=md-nav__link> Minutes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_5> <label class=md-nav__link for=__nav_7_5 id=__nav_7_5_label tabindex=0> Subgroups <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_5_label aria-expanded=false> <label class=md-nav__title for=__nav_7_5> <span class="md-nav__icon md-icon"></span> Subgroups </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_5_1> <label class=md-nav__link for=__nav_7_5_1 id=__nav_7_5_1_label tabindex=0> Documentation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_7_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_5_1> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../wg_docs/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../wg_docs/okd-io/ class=md-nav__link> Modifying OKD.io </a> </li> <li class=md-nav__item> <a href=../../wg_docs/doc-env/ class=md-nav__link> Setup environment </a> </li> <li class=md-nav__item> <a href=../../wg_docs/content/ class=md-nav__link> Content guidelines </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_5_2> <label class=md-nav__link for=__nav_7_5_2 id=__nav_7_5_2_label tabindex=0> CRC Build <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_7_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_5_2> <span class="md-nav__icon md-icon"></span> CRC Build </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../wg_crc/overview/ class=md-nav__link> Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_5_3> <label class=md-nav__link for=__nav_7_5_3 id=__nav_7_5_3_label tabindex=0> OKD Virtualization <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_7_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_7_5_3> <span class="md-nav__icon md-icon"></span> OKD Virtualization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../wg_virt/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../wg_virt/community/ class=md-nav__link> Community </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> OKD Development <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> OKD Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../okd_tech_docs/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../okd_tech_docs/modifying_okd/ class=md-nav__link> Modifying OKD </a> </li> <li class=md-nav__item> <a href=../../okd_tech_docs/operators/ class=md-nav__link> Operator Hub catalogs </a> </li> <li class=md-nav__item> <a href=../../okd_tech_docs/release/ class=md-nav__link> Release </a> </li> <li class=md-nav__item> <a href=../../okd_tech_docs/troubleshoot/ class=md-nav__link> Troubleshooting </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> Help <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../help/ class=md-nav__link> Getting Help </a> </li> <li class=md-nav__item> <a href=../../faq/ class=md-nav__link> FAQ </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#whats-the-payload class=md-nav__link> What's the payload? </a> </li> <li class=md-nav__item> <a href=#building-okdscos-the-prow-way-railway_track class=md-nav__link> Building OKD/SCOS the Prow way :railway_track: </a> <nav class=md-nav aria-label="Building OKD/SCOS the Prow way :railway_track:"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#imagestreams class=md-nav__link> ImageStreams </a> </li> <li class=md-nav__item> <a href=#triggers-for-building-most-payload-images class=md-nav__link> Triggers for building most payload images </a> </li> <li class=md-nav__item> <a href=#trigger-for-building-the-okd-specific-payload-images class=md-nav__link> Trigger for building the OKD-specific payload images </a> </li> <li class=md-nav__item> <a href=#okd-release-builds class=md-nav__link> OKD release builds </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#building-the-tekton-way-motorway class=md-nav__link> Building the Tekton way :motorway: </a> <nav class=md-nav aria-label="Building the Tekton way :motorway:"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#triggers class=md-nav__link> Triggers </a> </li> <li class=md-nav__item> <a href=#batch-build-task class=md-nav__link> Batch Build Task </a> </li> <li class=md-nav__item> <a href=#new-release-task class=md-nav__link> New Release Task </a> </li> <li class=md-nav__item> <a href=#buildconfigs class=md-nav__link> BuildConfigs </a> </li> <li class=md-nav__item> <a href=#updating-build-configs class=md-nav__link> Updating build configs </a> </li> <li class=md-nav__item> <a href=#preparing-for-a-new-release class=md-nav__link> Preparing for a new release </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#take-away class=md-nav__link> Take away </a> <nav class=md-nav aria-label="Take away"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-are-our-next-steps class=md-nav__link> What are our next steps? </a> </li> <li class=md-nav__item> <a href=#opened-perspectives class=md-nav__link> Opened perspectives </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=building-the-okd-payload>Building the OKD payload<a class=headerlink href=#building-the-okd-payload title="Permanent link">&para;</a></h1> <!--- cSpell:ignore SCOS buildconfigs buildconfig Kustomize kustomization baremetal --> <p>Over the last couple of months, we've been busy building a new OKD release on <a href=https://www.centos.org/centos-stream/ >CentOS Stream</a> <a href=https://en.wikipedia.org/wiki/Container_Linux>CoreOS</a> (SCOS), and were able to present it for the <a href=https://www.okd.io/blog/2022-10-20-OKD-at-Kubecon-NA-Detroit/ >OpenShift Commons Detroit 2022</a>. </p> <p>While some of us created a Tekton pipeline that could <a href="https://www.youtube.com/watch?v=HcGsvSms--A&list=PLaR6Rq6Z4Iqck7Z0ekuJdsMU1fE6hkd6d&index=2">build SCOS</a> on a Kind cluster, others were tediously building the OKD payload with Prow, but also creating a <a href=https://tekton.dev/ >Tekton</a> pipeline for building that payload on any OpenShift or OKD cluster.</p> <p>The goal of this effort is to enable and facilitate community collaboration and contributions, giving anybody the ability to do their own payload builds and run tests themselves.</p> <p>This process has been difficult because OpenShift's Prow CI instance is not open to the public, and changes could thus not easily be tested before PR submission. Even after opening a PR, a non-Red Hatter will require a Red Hat engineer to add the <code>/ok-to-test</code> label in order to start Prow testing.</p> <p>With the new Tekton pipelines, we are now providing a straight forward way for anybody to build and test their own changes first (or even create their own Stream entirely), and then present the results to the OKD Working Group, which will then expedite the review process on the PR.</p> <p>In this article, I will shed some light on the building blocks of the OKD on SCOS payload, how it is built, both the Prow way, and the Tekton way: </p> <h2 id=whats-the-payload>What's the payload?<a class=headerlink href=#whats-the-payload title="Permanent link">&para;</a></h2> <p>Until now, the OKD payload, like the OpenShift payload, was built by the <a href=https://github.com/openshift/release/tree/master/core-services/release-controller>ReleaseController</a> in Prow.</p> <blockquote> <p>The release-controller automatically builds OpenShift release images when new images are created for a given OpenShift release. It detects changes to an image stream, launches a job to build and push the release payload image using <code>oc adm release new</code>, and then runs zero or more ProwJobs against the artifacts generated by the payload. </p> </blockquote> <p>A release image is nothing more than a ClusterVersionOperator image (CVO), with an extra layer containing the <code>release-manifests</code> folder. This folder contains : * <code>image-references</code>: a list of all known images with their SHA digest, * yaml manifest files for each operator controlled by the CVO.</p> <p>The list of images that is included in the <code>release-manifests</code> is calculated from the <code>release</code> <a href=https://developers.redhat.com/blog/2019/09/20/using-red-hat-openshift-image-streams-with-kubernetes-deployments#>image stream</a>, taking : * all images with label <code>io.openshift.release.operator=true</code> in that image stream * plus any images referenced in the <code>/manifests/image-references</code> file within each of the images with this label.</p> <p>As you can imagine, the list of images in a release can change from one release to the next, depending on: * new operators being delivered within the OpenShift release * existing operators adding or removing an operand image * operators previously included that are removed from the payload to be delivered independently, through OLM instead.</p> <p>In order to list the images contained in a release payload, run this command:</p> <div class=highlight><pre><span></span><code>oc<span class=w> </span>adm<span class=w> </span>release<span class=w> </span>info<span class=w> </span><span class=si>${</span><span class=nv>RELEASE_IMAGE_URL</span><span class=si>}</span>
</code></pre></div> <p>For example:</p> <div class=highlight><pre><span></span><code>oc<span class=w> </span>adm<span class=w> </span>release<span class=w> </span>info<span class=w> </span>quay.io/okd/scos-release:4.12.0-0.okd-scos-2022-12-02-083740<span class=w> </span>
</code></pre></div> <p>Now that we've established what needs to be built, let's take a deeper look at how the OKD on SCOS payload is built.</p> <h2 id=building-okdscos-the-prow-way-railway_track>Building OKD/SCOS the Prow way <code>:railway_track:</code><a class=headerlink href=#building-okdscos-the-prow-way-railway_track title="Permanent link">&para;</a></h2> <p>The obvious way to build OKD on SCOS is to use <a href=https://docs.prow.k8s.io/docs/ >Prow</a> - THE Kubernetes-based CI/CD system, which is what builds OCP and OKD on FCOS already today. This is what Kubernetes uses upstream as well. :shrug:</p> <p>For a new OKD release to land in the <a href=https://origin-release.ci.openshift.org>releases</a> page, there's a whole bunch of Prow jobs that run. Hang on! It's a long story...</p> <h3 id=imagestreams>ImageStreams<a class=headerlink href=#imagestreams title="Permanent link">&para;</a></h3> <p>Let's start by the end :wink:, and prepare a new image stream for OKD on SCOS images. This ImageStream (IS) is a placeholder for all images that form the OKD/SCOS payload.</p> <p>For OKD on Fedora CoreOS (OKD/FCOS) it's named <code>okd</code>.For OKD/SCOS, this ImageStream is named <code>okd-scos</code>. </p> <p>This ImageStream includes all payload images contained in the specific <code>OKD</code> release based on CentOS Stream CoreOS (SCOS) </p> <p>Among these payload images, we distinguish: * Images that can be shared between OCP and OKD. These are built in Prow and mirrored into the <code>okd-scos</code> ImageStream.<br> * Images that have to be specifically built for OKD/SCOS, which are directly tagged into the <code>okd-scos</code> ImageStream. This is the case for images that are specific to the underlying operating system, or contain RHEL packages. These are: the <code>installer</code> images, the <code>machine-config-operator</code> image, the <code>machine-os-content</code> that includes the base operating system OSTree, as well as the <code>ironic</code> image for provisioning bare-metal nodes, and a few other images.</p> <h3 id=triggers-for-building-most-payload-images>Triggers for building most payload images<a class=headerlink href=#triggers-for-building-most-payload-images title="Permanent link">&para;</a></h3> <p>Now that we've got the recipient Image Stream for the OKD payload images, let's start building some payloads! </p> <p>Take the <a href=https://github.com/openshift/cluster-network-operator>Cluster Network Operator</a> for example:<br> For this operator, the same image can be used on OCP CI and OKD releases. Most payload images fit into this case. </p> <p>For such an image, the build is pretty straight forward. When a PR is filed for a GitHub repository that is part of a release payload: * The Pre-submit jobs run. It essentially builds the image and stores it in an ImageStream in an ephemeral namespace to run tests against several platforms (AWS, GCP, BareMetal, Azure, etc) * Once the tests are green and the PR is approved and merges, the Post-submit jobs run. It essentially promotes the built image to the appropriate release-specific ImageStream: * if the PR is for master, images are pushed to the <code>${next-release}</code> ImageStream * If the PR is for <code>release-${MAJOR}.${MINOR}</code>, images are pushed to the <code>${MAJOR}.${MINOR}</code> ImageStream</p> <p>Next, the <a href=https://github.com/openshift/release/blob/master/core-services/release-controller/_releases/release-ocp-4.13-ci.json#L12>OCP release controller</a> which runs at every change to the ImageStream, will mirror all images from the <code>${MAJOR}.${MINOR}</code> ImageStream to the <code>scos-${MAJOR}.${MINOR}</code> ImageStream.</p> <!-- 
Replacing mermaid diagrams with rendered image until style coloring is fixed
https://github.com/okd-project/okd.io/issues/18

<pre class="mermaid"><code>graph TD;
    PR[fa:fa-github PullRequest]-- submitted --&gt;PreSub{{fa:fa-ship PreSubmitJob}};
    PreSub-- builds --&gt;tis[(temporary IS)];
    PreSub-- runs --&gt;test{{Platform tests}};
    test -. against .- tis
    PR-- merged --&gt;PostSub{{fa:fa-ship PostSubmitJob}};
    PostSub-- promotes --&gt;isci[(OCP CI IS 4.x)];
    PostSub -. from .- tis
    RCtrl{{fa:fa-ship ReleaseController}}-- mirrors --&gt;isokd[(OKD IS scos-4.x)];
    RCtrl -. from .- isci
</code></pre>
--> <p><img alt="release process" src=../img/build_okd_payload_1.png></p> <p>As mentioned before, some of the images are not mirrored, and that brings us to the next section, on building those images that have content (whether code or manifests) specific to OKD.</p> <h3 id=trigger-for-building-the-okd-specific-payload-images>Trigger for building the OKD-specific payload images<a class=headerlink href=#trigger-for-building-the-okd-specific-payload-images title="Permanent link">&para;</a></h3> <p>For the OKD-specific images, the CI process is a bit different, as the image is built in the PostSubmit job and then directly promoted to the <code>okd-scos</code> IS, without going through the OCP CI to OKD mirroring step. This is called <a href=https://docs.ci.openshift.org/docs/how-tos/contributing-openshift-release/#variants>a variant configuration</a>. You can see this for <a href=https://github.com/openshift/release/blob/master/ci-operator/config/openshift/machine-config-operator/openshift-machine-config-operator-master__okd-scos.yaml>MachineConfigOperator</a> for example. </p> <!--
<pre class="mermaid"><code>graph TD;
    PR[fa:fa-github PullRequest]-- submitted --&gt;PreSubRHCOS{{fa:fa-gears fa:fa-prow PreSubmitJob / OCP CI}};
    PreSubRHCOS:::RHCOS-- builds --&gt;tis[(temporary IS)];
    PreSubRHCOS-- runs --&gt;testRHCOS{{Platform tests}};
    testRHCOS:::RHCOS -. against .- tis

    PR[fa:fa-github PullRequest]-- submitted --&gt;PreSubSCOS{{fa:fa-gears fa:fa-prow PreSubmitJob / OKD}};
    PreSubSCOS:::SCOS-- builds --&gt;tis[(temporary IS)];
    PreSubSCOS-- runs --&gt;testSCOS{{Platform tests}};
    testSCOS:::SCOS -. against .- tis

    PR-- merged --&gt;PostSubRHCOS{{fa:fa-gears PostSubmitJob / OCP CI}};
    PostSubRHCOS:::RHCOS-- promotes --&gt;isocp[(OCP CI IS 4.x)];
    PostSubRHCOS -. from .- tis

    PR-- merged --&gt;PostSubSCOS{{fa:fa-gears PostSubmitJob / OKD}};
    PostSubSCOS:::SCOS-- promotes --&gt;isokd[(OKD IS scos-4.x)]:::SCOS;
    PostSubSCOS -. from .- tis

     classDef RHCOS fill:;
     classDef SCOS fill:#1e97fa;</code></pre>
--> <p><img alt="trigger for building" src=../img/build_okd_payload_2.png></p> <p>The built images land directly in the <code>scos-${MAJOR}-${MINOR}</code> ImageStream. </p> <p>That is why there's no need for OCP's CI release controller to mirror these images from the CI ImageStream: During the PostSubmit phase, images are already getting built in parallel for OCP, OKD/FCOS and OKD/SCOS and pushed, respectively to <code>ocp/$MAJOR.$MINOR</code>, <code>origin/$MAJOR.$MINOR</code>, <code>origin/scos-$MAJOR.$MINOR</code></p> <h3 id=okd-release-builds>OKD release builds<a class=headerlink href=#okd-release-builds title="Permanent link">&para;</a></h3> <p>Now the ImageStream <code>scos-$MAJOR.$MINOR</code> is getting populated by payload images. With every new image tag, the <a href=https://github.com/openshift/release/blob/master/core-services/release-controller/_releases/release-okd-scos-4.13.json>release controller for OKD/SCOS</a> will build a release image.</p> <p>The ReleaseController ensures that OpenShift update payload images (aka release images) are created whenever an ImageStream representing the images in a release is updated. </p> <p>Thanks to the annotation <code>release.openshift.io/config</code> on the <code>scos-${MAJOR}-{MINOR}</code> ImageStream, the controller will: 1. Create a tag in the <code>scos-${MAJOR}-{MINOR}</code> ImageStream that uses the release name + current timestamp. 2. Mirror all of the tags in the input ImageStream so that they can't be pruned. 3. Launch a job in the job namespace to invoke <code>oc adm release new</code> from the mirror pointing to the release tag we created in step 1. 4. If the job succeeds in pushing the tag, it sets an annotation on that tag <code>release.openshift.io/phase = "Ready"</code>, indicating that the release can be used by other steps. And that's how a new release appears in https://origin-release.ci.openshift.org/#4.13.0-0.okd-scos 5. The release state switches to "Verified" when the <a href=https://github.com/openshift/release/blob/master/core-services/release-controller/_releases/release-okd-scos-4.13.json#L20>verification end-to-end test job</a> succeeds.</p> <h2 id=building-the-tekton-way-motorway>Building the Tekton way :motorway:<a class=headerlink href=#building-the-tekton-way-motorway title="Permanent link">&para;</a></h2> <p>Building with Prow has the advantage of being driven by new code being pushed to payload components, thus building fresh releases as the code of <a href=https://github.com/openshift>github.com/openshift</a> evolves.</p> <p>The problem is that Prow, along with all the clusters involved with it, the ImageStreams, etc. are not accessible to the OKD community outside of RedHat. Also, users might be interested in building custom OKD payload, in their own environment, to experiment exchanging components for example.</p> <p>To remove this impediment, the OKD team has been working on the OKD Payload pipeline based on Tekton.</p> <p>Building OKD payloads with Tekton can be done by cloning the <a href=https://github.com/okd-project/okd-payload-pipeline>okd-payload-pipeline repository</a>. One extra advantage of this repository is the ability to see the list of components that form the OKD payload: In fact, the list under <a href=https://github.com/okd-project/okd-payload-pipeline/tree/main/buildconfigs>buildconfigs</a> corresponds to the images in the OKD final payload. This list is currently manually synced with the list of OCP images on each release. </p> <p>The pipeline is fairly simple. Take the <a href=https://github.com/okd-project/okd-payload-pipeline/blob/main/pipelines/build-from-scratch.yaml>build-from-scratch.yaml</a> for example. It has 3 main tasks: * Build the base image and the builder image, with which all the payload images will be built * The builder image is a CentOS Stream 9 container image that includes all the dependencies needed to build payload components and is used as the build environment for them * The built binaries are then layered onto a CentOS Stream 9 base image, creating a payload component image. * The base image is shared across all the images in the release payload * Build payload images in batches (starting with the ones that don't have any dependencies) * Finally, as all OKD payload component images are in the image stream, the OKD release image is in turn built, using the <code>oc adm release new</code> command.</p> <!--
<pre class="mermaid"><code>graph TB
    subgraph pipeline
    direction LR

    pipelineRun{{fa:fa-gears PipelineRun}}-- starts --&gt; taskRunBuilderBase{{fa:fa-gears TaskRun - BatchBuild}}

    taskRunBuilderBase -- runBefore --&gt; taskRun1{{fa:fa-gears BatchBuild#1}};
    taskRun1 -- runBefore --&gt; taskRun2{{fa:fa-gears BatchBuild#2}};
    taskRun2 -- runBefore --&gt; payloadRelease{{fa:fa-gears BuildRelease}}

    taskRunBuilderBase -- builds --&gt; base(fa:fa-cube base)
    taskRunBuilderBase -- builds --&gt; builder(fa:fa-cube builder)

    taskRun1 -- builds --&gt; payloadImage101(fa:fa-cube Payload-101)
    taskRun1 -- builds --&gt; payloadImage102(fa:fa-cube Payload-102) 

    taskRun2 -- builds --&gt; payloadImage201(fa:fa-cube Payload-201) 
    taskRun2 -- builds --&gt; payloadImage202(fa:fa-cube Payload-201)

    payloadRelease -- builds --&gt; payloadReleaseImage(fa:fa-cube Payload-Release)

    base                 -- pushed --&gt; IS[(IS origin)]
    builder              -- pushed --&gt; IS
    payloadImage101      -- pushed --&gt; IS
    payloadImage102      -- pushed --&gt; IS
    payloadImage201      -- pushed --&gt; IS
    payloadImage202      -- pushed --&gt; IS
    payloadReleaseImage  -- pushed --&gt;quay[(quay.io)];
    quay &lt;-.- IS

    end
</code></pre>
--> <p><img alt=pipeline src=../img/build_okd_payload_3.png></p> <h3 id=triggers>Triggers<a class=headerlink href=#triggers title="Permanent link">&para;</a></h3> <p>For the moment, this pipeline has no triggers. It can be executed manually when needed. We are planning to automatically trigger the pipeline on a daily cadence.</p> <h3 id=batch-build-task>Batch Build Task<a class=headerlink href=#batch-build-task title="Permanent link">&para;</a></h3> <p>With a set of buildConfigs passed in the parameters, this task relies on an openshift <code>oc</code> image containing the client binary and loops on the list of build configs with a <code>oc start-build</code>, and waits for all the builds to complete. </p> <h3 id=new-release-task>New Release Task<a class=headerlink href=#new-release-task title="Permanent link">&para;</a></h3> <p>This task simply uses an OpenShift client image to call <code>oc adm release new</code> which creates the release image from the image stream <code>release</code> (on the OKD/OpenShift cluster where this Tekton pipeline is running), and mirroring the release image, and all the payload component images to a registry configured in its parameters. </p> <h3 id=buildconfigs>BuildConfigs<a class=headerlink href=#buildconfigs title="Permanent link">&para;</a></h3> <p>As explained above, the OKD payload Tekton pipeline heavily relies on the <a href=https://github.com/okd-project/okd-payload-pipeline/tree/main/buildconfigs>buildconfigs</a>. This folder contains one buildconfig yaml file for each image included in the release payload. </p> <p>Each build config simply uses a builder image to build the operator binary, invoking the correct Dockerfile in the operator repository. Then, the binary is copied as a layer on top of an OKD base image, which is built in the preparatory task of the pipeline. </p> <p>This process currently uses the <a href=https://docs.okd.io/4.11/cicd/builds/understanding-image-builds.html>OpenShift Builds API</a>. We are planning to move these builds to the <a href=https://shipwright.io/ >Shipwright</a> Builds API in order to enable builds outside of OCP or OKD clusters.</p> <h3 id=updating-build-configs>Updating build configs<a class=headerlink href=#updating-build-configs title="Permanent link">&para;</a></h3> <p>Upon deploying the Tekton OKD Payload pipeline on an OKD (or OpenShift) cluster, Kustomize is used in order to : * patch the BuildConfig files, adding TAGS to the build arguments according to the type of payload we want to build (based on FCOS, SCOS or any other custom stream) * patch the BuildConfig files, replacing the builder image references to the non-public <code>registry.ci.openshift.org/ocp/builder</code> in the payload component's Dockerfiles with the builder image reference from the local image stream * setting resource requests and limits if needed</p> <h3 id=preparing-for-a-new-release>Preparing for a new release<a class=headerlink href=#preparing-for-a-new-release title="Permanent link">&para;</a></h3> <p>The procedure to prepare a new release is still a work in progress at the time of writing.</p> <p>To build a new release, each BuildConfig file should be updated with the git branch corresponding to that release.<br> In the future, the branch can be passed along as a kustomization, or in the parameters of the pipeline. </p> <p>The list of images from a new OCP release (obtained through <code>oc adm release info</code>) must now be synced with the BuildConfigs present here: * For any new image, a new BuildConfig file must be added * For any image removed from the OCP release, the corresponding BuildConfig file must be removed.</p> <h2 id=take-away>Take away<a class=headerlink href=#take-away title="Permanent link">&para;</a></h2> <h3 id=what-are-our-next-steps>What are our next steps?<a class=headerlink href=#what-are-our-next-steps title="Permanent link">&para;</a></h3> <p>In the coming weeks and months, you can expect lots of changes, especially as the OKD community is picking up usage of OKD/SCOS, and doing their own Tekton Pipeline runs: * Work to automate the OKD release procedure is progress by automatically verifying payload image signatures, signing the release, and tagging it on GitHub.</p> <p>The goal is to deliver a new OKD/SCOS on a sprint (3-weekly) basis, and to provide both the OCP teams and the OKD community with a fresh release to test much earlier than previously with the OCP release cadence. * For the moment, OKD/SCOS releases are only verified on AWS. To gain more confidence in our release payloads, we will expand the test matrix to other platforms such as GCP, vSphere and Baremetal * Enable GitOps on the Tekton pipeline repository, so that changes to the pipeline are automatically deployed on <a href=https://www.operate-first.cloud/ >OperateFirst</a> for the community to use the latest and greatest. * The OKD Working Group will be collaborating with the <a href=https://massopen.cloud/ >Mass Open Cloud</a> to allow for deployments of test clusters on their baremetal infrastructure. * The OKD Working Group will be publishing the Tekton Tasks and Pipelines used to build the SCOS Operating System as well as the OKD payload to <a href=https://hub.tekton.dev/ >Tekton Hub</a> and <a href=https://artifacthub.io/ >Artifact Hub</a> * The <a href=https://github.com/okd-project/okd-operator-pipeline/ >OKD operators Tekton pipeline</a> will be used for community builds of optional OLM operators. A first OKD operator has already been built with it, and other operators are to follow, starting with the Pipelines operator, which has long been an ask by the community * Additionally, we are working on multi-arch releases for both OKD/SCOS and OKD/FCOS</p> <h3 id=opened-perspectives>Opened perspectives<a class=headerlink href=#opened-perspectives title="Permanent link">&para;</a></h3> <p>Although in the near future the OKD team will still rely on Prow to build the payload images, the Tekton pipeline will start getting used to finalize the release.</p> <p>In addition, this Tekton pipeline has opened up new perspectives, even for OCP teams. </p> <p>One such example is for the <a href=https://github.com/openshift/api>Openshift API team</a> who would like to use the Tekton pipeline to test API changes by building all components that are dependent of the OpenShift API from that PR, create an OKD release and test it thus getting extra quick feedback on impacts of the API changes on the OKD (and later OCP) releases.</p> <p>Another example is the possibility to build images on other platforms than Openshift or OKD platform, replacing build configs with Shipwright, or why not <code>docker build</code>...</p> <p>Whatever your favorite flavor is, we are looking forward to seeing the pipelines in action, increasing collaboration and improving our community feedback loop.</p> </article> </div> </div> </main> <!-- Footer --> <footer class=md-footer> <div class=container> <div class=row> <!-- Social Section --> <div class="col-md-4 col-sm-12"> <a href=https://www.redhat.com/ > <img alt="Red Hat" src=https://assets.openshift.com/hubfs/images/logos/Logo-RedHat-A-Reverse-RGB.svg style="width: 128px"> </a> </div> <div class="col-md-4 col-sm-12"> <ul class=social> <li class=twitter> <a href=https://twitter.com/okd_io> <span> <i class="fa fa-twitter-square"></i> </span> </a> </li> <li class=github> <a href=https://github.com/okd-project/okd> <span> <i class="fa fa-github"></i> </span> </a> </li> <li class=google> <a href=https://plus.google.com/communities/114361859072744017486> <span> <i class="fa fa-google-plus-square"></i> </span> </a> </li> <li class=facebook> <a href=https://www.facebook.com/openshift> <span> <i class="fa fa-facebook-square"></i> </span> </a> </li> </ul> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "navigation.instant", "naviagation.sections", "navigation.tracking", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.51198bba.min.js></script> </body> </html>